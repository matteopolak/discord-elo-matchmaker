generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Mode {
  Ranked
  Unranked
  Open
}

enum GameState {
  PickingTeams
  BanningMaps
  Playing
  Scoring
  Finished
  Voided
}

model Category {
  id      String @id
  guildId String
}

model Party {
  leaderId String   @id
  members  User[]
  invites  String[]
}

model Queue {
  id      String @id
  guildId String
  mode    Mode
}

model Map {
  url        String
  name       String
  name_lower String  @id
  enabled    Boolean @default(true)
  height     Int     @db.SmallInt
}

model PickedPlayer {
  userId String
  team   Int    @db.SmallInt
  game   Game   @relation(fields: [gameId], references: [id])
  gameId Int
  user   User   @relation(fields: [userId], references: [id])

  @@id([userId, gameId])
  @@index([userId])
}

model Game {
  id              Int            @id @default(autoincrement())
  state           GameState
  mode            Mode
  players         PickedPlayer[]
  lastPickIndex   Int            @default(-1) @db.SmallInt
  captains        String[]
  remainingIds    String[]
  textChannelId   String         @unique
  voiceChannelIds String[]
  bannedMaps      String[]
  captainMapBans  String[]
  createdAt       DateTime       @default(now())
  startedAt       DateTime?
  endedAt         DateTime?

  @@index([textChannelId])
  @@index([voiceChannelIds])
}

model Faction {
  leaderId   String   @id
  name       String?
  name_lower String?  @unique
  members    User[]
  invites    String[]
  experience Int      @default(0)
  createdAt  DateTime @default(now())
}

model User {
  id          String         @id
  bannedUntil BigInt?
  profiles    Profile[]
  uuid        String         @unique @db.Uuid
  username    String
  faction     Faction?       @relation(fields: [factionId], references: [leaderId])
  factionId   String?
  createdAt   DateTime       @default(now())
  party       Party          @relation(fields: [partyId], references: [leaderId])
  partyId     String
  picks       PickedPlayer[]
}

model Profile {
  user       User   @relation(fields: [userId], references: [id])
  userId     String
  mode       Mode
  wins       Int    @default(0)
  winstreak  Int    @default(0)
  losses     Int    @default(0)
  losestreak Int    @default(0)
  mvps       Int    @default(0)
  rating     Int    @default(0)

  @@id([mode, userId])
}

model Event {
  messageId String   @id
  event     String
  userId    String
  expiresAt DateTime
}
